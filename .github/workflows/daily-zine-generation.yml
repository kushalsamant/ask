name: Daily Instagram Story Generation (No .env File)

on:
  schedule:
    # Runs 4 times daily at 03:00, 09:00, 15:00, 21:00 UTC
    - cron: '0 3,9,15,21 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  generate-stories:
    runs-on: ubuntu-latest

    env:
      # === API & MODEL CONFIG ===
      TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
      TOGETHER_API_BASE: "https://api.together.xyz/v1"
      TOGETHER_API_URL: "https://api.together.xyz/v1"
      IMAGE_MODEL: "black-forest-labs/FLUX.1-schnell-free"

      # === IMAGE GENERATION SETTINGS ===
      IMAGE_WIDTH: "1072"
      IMAGE_HEIGHT: "1792"
      INFERENCE_STEPS: "4"
      GUIDANCE_SCALE: "7.5"
      IMAGE_QUALITY: "95"
      API_TIMEOUT: "60"
      DOWNLOAD_TIMEOUT: "30"
      RATE_LIMIT_DELAY: "10.0"
      MAX_RETRIES: "3"
      RETRY_DELAY_MULTIPLIER: "30"
      RETRYABLE_STATUS_CODES: "408,429,500,502,503,504"

      # === QUESTIONS ===
      ARCHITECTURE_QUESTIONS: ${{ vars.ARCHITECTURE_QUESTIONS }}
      CONSTRUCTION_QUESTIONS: ${{ vars.CONSTRUCTION_QUESTIONS }}
      DESIGN_QUESTIONS: ${{ vars.DESIGN_QUESTIONS }}
      ENGINEERING_QUESTIONS: ${{ vars.ENGINEERING_QUESTIONS }}
      INTERIOR_QUESTIONS: ${{ vars.INTERIOR_QUESTIONS }}
      PLANNING_QUESTIONS: ${{ vars.PLANNING_QUESTIONS }}
      URBANISM_QUESTIONS: ${{ vars.URBANISM_QUESTIONS }}
      FALLBACK_ARCHITECTURE: "How can we design buildings that respond to climate change?"
      FALLBACK_CONSTRUCTION: "How can we build more efficiently with less waste?"
      FALLBACK_DESIGN: "How can we design spaces that adapt to changing needs?"
      FALLBACK_ENGINEERING: "How can we make buildings more resilient to disasters?"
      FALLBACK_INTERIORS: "How can interiors reflect the building's purpose?"
      FALLBACK_PLANNING: "How can we plan cities for people, not cars?"
      FALLBACK_URBANISM: "How can we create vibrant public spaces?"

      # === STYLES ===
      ARCHITECTURE_STYLES: "Modern Minimalist,Contemporary,Brutalist,Art Deco"
      CONSTRUCTION_STYLES: "High-Tech,Industrial,Modern,Contemporary"
      DESIGN_STYLES: "Contemporary,Postmodern,Organic Architecture,Expressionist"
      ENGINEERING_STYLES: "High-Tech,International Style,Modern,Constructivist"
      INTERIOR_STYLES: "Modern Minimalist,Contemporary,Art Nouveau,Beaux-Arts"
      PLANNING_STYLES: "International Style,Modern,Contemporary,Neo-Modern"
      URBANISM_STYLES: "Contemporary,Postmodern,Neo-Futurist,Modern"
      DEFAULT_STYLE: "Contemporary"

      # === TEXT & BRANDING ===
      FONT_FILE: "arial.ttf"
      MAIN_FONT_SIZE: "56"
      BRAND_FONT_SIZE: "36"
      NUMBER_FONT_SIZE: "28"
      OVERLAY_HEIGHT: "400"
      MAX_CHARS_PER_LINE: "35"
      MAX_TEXT_LINES: "2"
      LINE_HEIGHT: "72"
      TEXT_START_OFFSET: "80"
      BRAND_TEXT: "ASK: Daily Architectural Research"
      BRAND_TEXT_OFFSET: "56"
      BRAND_Y_OFFSET: "100"
      BRAND_X_POSITION: "30"
      NUMBER_FORMAT: "#{:02d}"
      NUMBER_X_OFFSET: "30"
      SHADOW_OFFSET: "2"
      SEPARATOR_LINE_WIDTH: "1"
      OVERLAY_TRANSPARENT: "0,0,0,0"
      SEPARATOR_LINE_COLOR: "255,255,255,40"
      SHADOW_COLOR: "0,0,0,80"
      TEXT_COLOR: "white"
      TEXT_SHADOW_COLOR: "0,0,0,100"

      # === LOGGING & DIRS ===
      LOG_DIR: "logs"
      IMAGES_DIR: "images"
      LOG_SEPARATOR_LENGTH: "60"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run story generation
        run: |
          echo "Starting Instagram story generation at $(date)"
          python daily.py

      - name: Commit and push generated content
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add images/ log.csv logs/
          git commit -m "Automated Instagram stories - $(date -u '+%Y-%m-%d %H:%M:%S') UTC" || echo "No changes to commit"
          git push
